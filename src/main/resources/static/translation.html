<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Traduction & Historique</title>
    <link rel="stylesheet" href="translation.css">
</head>
<body>

<h1>Traduction & Historique</h1>
<form id="monForm">
    <label for="nombre">Nombre :</label>
    <input type="number" min="1" id="nombre" required>

    <label for="langue">Langue :</label>
    <select id="langue">
        <option value="FR">FR</option>
        <option value="DE">DE</option>
    </select>

    <button type="submit">traduire</button>
</form>

<div id="resultat"></div>
<div id="erreur"></div>

<button id="afficher-historique">Afficher l'historique</button>

<div id="historique-container">
    <h2>Historique des recherches</h2>
    <table>
        <thead>
        <tr>
            <th>Nombre</th>
            <th>Langue</th>
            <th>Date et heure</th>
        </tr>
        </thead>
        <tbody id="historique-body">
        <!-- Les données d'historique seront insérées ici -->
        </tbody>
    </table>
</div>

<script>
    document.getElementById('monForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const nombre = document.getElementById('nombre').value;
        const langue = document.getElementById('langue').value;

        // Appel au microservice de traduction
        fetch(`http://localhost:803/translations/api/translations/search/${nombre}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Afficher la traduction
                const traduction = langue === 'FR' ? data.french : data.german;
                document.getElementById('resultat').textContent = 'Traduction : ' + traduction;
                document.getElementById('erreur').textContent = '';

                // Enregistrer dans l'historique
                return fetch('http://localhost:804/historique/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nombre: parseInt(nombre),
                        langue: langue,
                        localDateTime: new Date().toISOString()
                    })
                });
            })
            .catch(error => {
                document.getElementById('erreur').textContent = error.message;
                document.getElementById('resultat').textContent = '';
            });
    });

    // Gérer l'affichage de l'historique
    document.getElementById('afficher-historique').addEventListener('click', () => {
        const historiqueContainer = document.getElementById('historique-container');

        if (historiqueContainer.style.display === 'none' || !historiqueContainer.style.display) {
            // Charger et afficher l'historique
            chargerHistorique();
            historiqueContainer.style.display = 'block';
            document.getElementById('afficher-historique').textContent = 'Masquer l\'historique';
        } else {
            // Cacher l'historique
            historiqueContainer.style.display = 'none';
            document.getElementById('afficher-historique').textContent = 'Afficher l\'historique';
        }
    });

    // Fonction pour charger l'historique
    function chargerHistorique() {
        fetch('http://localhost:804/historique/list')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                const historiqueBody = document.getElementById('historique-body');
                historiqueBody.innerHTML = '';

                if (!data || data.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 3;
                    cell.textContent = 'Aucun historique disponible';
                    cell.style.textAlign = 'center';
                    row.appendChild(cell);
                    historiqueBody.appendChild(row);
                } else {
                    data.forEach(item => {
                        const row = document.createElement('tr');

                        const nombreCell = document.createElement('td');
                        nombreCell.textContent = item.nombre;
                        row.appendChild(nombreCell);

                        const langueCell = document.createElement('td');
                        langueCell.textContent = item.langue;
                        row.appendChild(langueCell);

                        const dateCell = document.createElement('td');
                        // Formatage de la date selon la structure reçue
                        if (item.localDateTime) {
                            if (typeof item.localDateTime === 'string') {
                                // Si c'est une chaîne ISO
                                dateCell.textContent = new Date(item.localDateTime).toLocaleString();
                            } else if (item.localDateTime.year) {
                                // Si c'est un objet LocalDateTime sérialisé
                                const date = new Date(
                                    item.localDateTime.year,
                                    item.localDateTime.monthValue - 1, // Mois commence à 0 en JavaScript
                                    item.localDateTime.dayOfMonth,
                                    item.localDateTime.hour,
                                    item.localDateTime.minute,
                                    item.localDateTime.second
                                );
                                dateCell.textContent = date.toLocaleString();
                            } else {
                                dateCell.textContent = "Format inconnu";
                            }
                        } else {
                            dateCell.textContent = "Date non disponible";
                        }
                        row.appendChild(dateCell);

                        historiqueBody.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error("Erreur:", error);
            });
    }
</script>
</body>
</html>